# Инструменты MCP-сервера

Документ описывает доступные инструменты MCP-сервера из `server.py`, формат их запросов и ответов,
а также особенности обработки изображений.

## Переменные окружения

- `ANKI_DEFAULT_DECK` — имя колоды, которое будет использоваться по умолчанию, если клиент не передал параметр `deck`.
- `ANKI_DEFAULT_MODEL` — имя модели, используемой по умолчанию при отсутствии параметра `model`.

Обе переменные необязательные: пустое значение приводит к использованию стандартных `"Default"` и `"Basic"` соответственно.

## Общие структуры данных

### `ImageSpec`
- **Назначение:** описывает изображение, которое нужно добавить к заметке Anki.
- **Поля:**
  - `image_base64: str | None` — необязательный Base64-контент изображения.
  - `image_url: AnyHttpUrl | None` — необязательная ссылка на изображение. Используется, если `image_base64` не передан.
  - `target_field: str` — поле модели, куда следует подставить тег `<img>`; по умолчанию `"Back"`.
  - `filename: str | None` — пользовательское имя медиа-файла. Если не задано, генерируется UUID с расширением `.jpg`.
  - `max_side: int` — максимальный размер длинной стороны при авто-ресайзе (по умолчанию `768`).

### `NoteInput`
- **Назначение:** входные данные для создания заметки.
- **Поля:**
  - `fields: Dict[str, str]` — значения полей заметки.
  - `tags: List[str]` — необязательные теги; по умолчанию пустой список.
  - `images: List[ImageSpec]` — список изображений (см. выше); по умолчанию пуст.
  - `dedup_key: str | None` — необязательный ключ для идемпотентности, используется в `anki.add_from_model`.

### `AddNotesArgs`
- **Используется в:** `anki.add_notes`.
- **Поля:**
  - `deck: str` — имя колоды. Если параметр не передан, используется значение из `ANKI_DEFAULT_DECK` (по умолчанию `"Default"`).
  - `model: str` — имя модели. При отсутствии значения используется `ANKI_DEFAULT_MODEL` (по умолчанию `"Basic"`).
  - `notes: List[NoteInput]` — список заметок (обязательный, минимум один элемент).

### `AddNotesResult`
- **Структура ответа** для инструментов, добавляющих заметки.
- **Поля:**
  - `added: int` — количество успешно созданных заметок.
  - `skipped: int` — количество пропущенных заметок (например, дубликатов).
  - `details: List[dict]` — дополнительные сведения по каждой заметке (индекс, статус, предупреждения и т.п.).

### `ModelInfo`
- **Используется в:** `anki.model_info`.
- **Поля:**
  - `model: str` — имя модели.
  - `fields: List[str]` — список полей модели.
  - `templates: Dict[str, Dict[str, str]]` — шаблоны карточек вида `{ "Card 1": { "Front": "...", "Back": "..." } }`.
  - `styling: str` — CSS-маркировка модели.

## Инструменты

### `anki.model_info`
- **Назначение:** получить актуальные поля, шаблоны (Front/Back) и CSS выбранной модели Anki.
- **Параметры:**
  - `model: str` — имя модели. Если параметр опущен, используется `ANKI_DEFAULT_MODEL` (`"Basic"`, если переменная не задана или пуста).
- **Ответ:** объект `ModelInfo` (см. выше).
- **Пример запроса:**
```json
{
  "name": "anki.model_info",
  "arguments": {
    "model": "Basic"
  }
}
```
- **Пример ответа:**
```json
{
  "model": "Basic",
  "fields": ["Front", "Back"],
  "templates": {
    "Card 1": {
      "Front": "{{Front}}",
      "Back": "{{FrontSide}}<hr id=\"answer\">{{Back}}"
    }
  },
  "styling": ".card { font-family: arial; }"
}
```

### `anki.add_from_model`
- **Назначение:** добавить заметки в указанную колоду с учётом текущих полей и шаблонов модели. Инструмент сам загружает поля модели, нормализует `fields` и обрабатывает вложенные изображения.
- **Параметры:**
  - `deck: str` — целевая колода. Если параметр опущен, используется `ANKI_DEFAULT_DECK` (`"Default"`, если переменная не задана или пуста).
  - `model: str` — модель карточки. По умолчанию берётся `ANKI_DEFAULT_MODEL` (`"Basic"`, если переменная не задана или пуста).
  - `items: List[NoteInput]` — список заметок (обязателен).
- **Ответ:** объект `AddNotesResult`.
- **Особенности:**
  - До добавления создаёт колоду при необходимости.
  - Поддерживает `dedup_key` и добавляет его в `details` успешных заметок.
  - Рекомендуется для сценариев, когда структура модели может отличаться от ожидаемой — инструмент сам приводит данные в соответствие.
- **Пример запроса:**
```json
{
  "name": "anki.add_from_model",
  "arguments": {
    "deck": "Default",
    "model": "Basic",
    "items": [
      {
        "fields": {"Front": "Столица Франции?", "Back": "Париж"},
        "tags": ["geo"],
        "images": [
          {
            "image_url": "https://example.com/paris.jpg",
            "target_field": "Back",
            "max_side": 512
          }
        ],
        "dedup_key": "geo-paris"
      }
    ]
  }
}
```
- **Пример ответа:**
```json
{
  "added": 1,
  "skipped": 0,
  "details": [
    {
      "index": 0,
      "status": "ok",
      "noteId": 1700000000000,
      "dedup_key": "geo-paris"
    }
  ]
}
```

### `anki.add_notes`
- **Назначение:** низкоуровневое добавление заметок без автоматической подстройки под структуру модели. Используется для случаев, когда клиент уже знает точное соответствие полей.
- **Параметры:**
  - `deck: str` — целевая колода. При отсутствии параметра используется `ANKI_DEFAULT_DECK` (`"Default"`).
  - `model: str` — модель карточки. Если аргумент опущен, применяется `ANKI_DEFAULT_MODEL` (`"Basic"`).
  - `notes: List[NoteInput]` — список заметок (обязателен, минимум один).
- **Ответ:** объект `AddNotesResult`.
- **Особенности:**
  - Не вызывает `get_model_fields_templates`, поэтому переданные `fields` должны соответствовать модели по названиям.
  - Сохраняет обратную совместимость со старыми клиентами.
- **Пример запроса:**
```json
{
  "name": "anki.add_notes",
  "arguments": {
    "deck": "Default",
    "model": "Basic",
    "notes": [
      {
        "fields": {"Front": "2+2", "Back": "4"},
        "tags": [],
        "images": []
      }
    ]
  }
}
```
- **Пример ответа:**
```json
{
  "added": 1,
  "skipped": 0,
  "details": [
    {
      "index": 0,
      "status": "ok",
      "noteId": 1700000000001
    }
  ]
}
```

### `greet`
- **Назначение:** тестовый пинг для проверки связи с MCP-сервером.
- **Параметры:**
  - `name: str` — имя пользователя (обязательный).
- **Ответ:** строка с приветствием.
- **Пример запроса:**
```json
{
  "name": "greet",
  "arguments": {
    "name": "Алиса"
  }
}
```
- **Пример ответа:**
```json
"Привет, Алиса! Я твой MCP-сервер."
```

## Работа с изображениями и HTML-полями

Обработка изображений выполняется в нескольких функциях.

1. **`process_data_urls_in_fields`** — ищет значения вида `data:image/...;base64,<данные>` во всех строковых полях заметки. При успешной декодировке:
   - вычисляет SHA-1 хэш бинарных данных для формирования уникального имени файла (`img_<hash>.<ext>`), где расширение выбирается функцией `ext_from_mime`;
   - сохраняет файл через `store_media_file`;
   - заменяет значение поля на имя файла, чтобы шаблон модели мог подставить `<img src="...">` автоматически;
   - записывает диагностическую информацию в `details` результата. При ошибках добавляет предупреждение с причиной.

2. **`fetch_image_as_base64`** — загружает изображение по URL и, если Pillow распознаёт формат, выполняет авто-ресайз: длинная сторона ограничивается `max_side`, изображение пересохраняется в JPEG с качеством `85`. Если обработка не удалась, файл отправляется как есть. Результат возвращается в Base64 для дальнейшей передачи в Anki.

3. **`ensure_img_tag`** — при обработке списка `images[]` добавляет в целевое поле HTML-тег `<img>` внутри обёртки `<div>` и сохраняет предыдущий текст поля. Если в поле уже были данные, новый тег отделяется пустой строкой для читаемости.

### Использование `images[]`

Каждый элемент `images[]` преобразуется следующим образом:
- выбирается имя файла: либо из `filename`, либо автоматически на основе UUID;
- источник данных — `image_base64` (приоритет) или `image_url` с последующей загрузкой через `fetch_image_as_base64` и возможным ресайзом до `max_side` пикселей;
- файл сохраняется через `store_media_file`;
- в поле `target_field` подставляется HTML, возвращённый `ensure_img_tag`, что гарантирует присутствие `<img>` даже если шаблон модели не делает этого автоматически.

### Сравнение сценариев `anki.add_from_model` и `anki.add_notes`

- `anki.add_from_model` предварительно запрашивает структуру модели (`modelFieldNames`, `modelTemplates`, `modelStyling`) и нормализует поля через `normalize_fields_for_model`. Это облегчает интеграцию с динамическими моделями и позволяет использовать `dedup_key` в отчёте.
- `anki.add_notes` не делает дополнительных запросов к Anki и ожидает, что клиент уже согласовал названия полей. Он служит для обратной совместимости с существующими сценариями и может быть быстрее, если структура модели известна заранее.

Оба инструмента используют общие механизмы обработки `data:image/...;base64` и `images[]`, что обеспечивает единое поведение при работе с медиа.
