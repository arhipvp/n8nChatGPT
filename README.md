# n8n ChatGPT MCP Bridge

## Назначение
Проект запускает локальный MCP-сервер на базе [`fastmcp`](https://github.com/entrez/fastmcp) и пробрасывает его наружу через `ngrok`, чтобы подключить кастомный коннектор в ChatGPT. Основная логика описана в [`main.py`](main.py).

## Зависимости
Для работы требуется Python 3.10+ и следующие пакеты (см. запуск MCP-сервера в `main.py`):
- `fastmcp`
- `httpx`
- `Pillow`

- `requests`
- Anki с установленным плагином [AnkiConnect](https://foosoft.net/projects/anki-connect/) и запущенным Anki-клиентом

## Требования к ngrok
Скрипт ищет исполняемый файл ngrok рядом с собой (`main.py` определяет абсолютный путь к каталогу проекта), затем в `PATH` и типичных папках Windows, после чего поднимает HTTP-туннель и извлекает публичный URL через локальный API `http://127.0.0.1:4040`. Эти шаги реализованы в функциях `find_ngrok_exe`, `ngrok_api_alive` и `get_ngrok_url` в `main.py`. Убедитесь, что:
- ngrok установлен; авторизация произойдёт автоматически, если задать `NGROK_AUTHTOKEN` в `.env` или окружении (файл `.env` подхватывается относительно директории скрипта, поэтому запуск из любого рабочего каталога допустим);
- доступен через `ngrok.exe`/`ngrok` рядом с проектом или в `PATH`;
- свободна сессия для запуска HTTP-туннеля на порт 8000.

## Пошаговый сценарий
1. **Подготовка окружения**
   - Установите зависимости: `pip install fastmcp httpx Pillow requests python-dotenv`.
   - Убедитесь, что Anki запущен, а расширение AnkiConnect активно.
   - Скопируйте `.env`-шаблон: `cp env.example .env` и впишите значение `NGROK_AUTHTOKEN=<ваш_токен>`.
     Файл `.env` должен лежать рядом с `main.py`: скрипт определяет абсолютный путь к собственной директории и всегда читает переменные окружения именно оттуда, поэтому можно запускать его из любого каталога.
   - При необходимости укажите `SEARCH_API_URL` и `SEARCH_API_KEY`: первая переменная задаёт конечную точку внешнего поиска (например, webhook в n8n), вторая — токен/ключ авторизации. Если поиск не нужен, оставьте их пустыми.
   - Поместите `ngrok` рядом с проектом или добавьте в `PATH`.
2. **Запуск**
   - Выполните команду `python main.py`.
   - Скрипт стартует MCP-сервер (`fastmcp run server.py:app --transport http --host 127.0.0.1 --port 8000`) и поднимет ngrok-туннель. Токен берётся из переменной окружения `NGROK_AUTHTOKEN`, загруженной из `.env`.
3. **Ожидаемые сообщения**
   - В консоли появится блок вида:
     ```
     ✅ Всё поднято!
     • Локально:   http://127.0.0.1:8000/mcp
     • Публично:   https://....ngrok-free.app/mcp
     ```
     Эти строки выводятся после получения публичного URL от ngrok.
4. **Подключение коннектора**
   - Скопируйте опубликованный адрес `/mcp`, затем в интерфейсе ChatGPT откройте **Settings → Connectors → Add a connector → MCP Server** и вставьте его в поле URL.
   - Поля авторизации оставьте пустыми — она не требуется.
   - После добавления активируйте коннектор внутри конкретного чата, где планируете работать с Anki.
   - Оставьте окно запущенного скрипта открытым (терминал с `python main.py`); завершение `Ctrl+C` корректно остановит MCP и ngrok, а при закрытом терминале коннектор станет недоступен.

## Что умеет сервер
- `anki.model_info` — возвращает актуальные поля, шаблоны карточек и CSS выбранной модели Anki, чтобы ChatGPT мог заранее сформировать корректные поля. Параметр `model` можно не передавать — по умолчанию используется `ANKI_DEFAULT_MODEL` (`"Basic"`, если переменная не задана или пуста).
- `anki.add_from_model` — нормализует поля под модель, преобразует встроенные `data:`-URL в медиафайлы, загружает изображения по URL/base64 с ресайзом и отмечает результаты через `dedup_key`, помогая ChatGPT безопасно обновлять карточки без дублей.
- `anki.add_notes` — низкоуровневый аналог без авто-подстановки полей модели для случаев, когда структуру карточки контролирует пользователь.
- `greet` — простой «пинг», позволяющий проверить, что сервер отвечает.
- `search` — универсальное действие для интеграции с внешним поиском (n8n workflow, веб-API и т.п.), возвращающее массив результатов и `nextCursor` для постраничной навигации.

Благодаря этим инструментам ChatGPT может получать структуру колоды, автоматически прикреплять изображения к карточкам, переиспользовать `dedup_key` для идемпотентных запросов и надёжно создавать либо дополнять заметки Anki напрямую из чата. Подробные параметры и примеры обращений описаны в [docs/tools.md](docs/tools.md).

## Локальный smoke-тест
Запустите `python test_client.py`, чтобы проверить базовое взаимодействие с MCP-сервером без туннеля.
